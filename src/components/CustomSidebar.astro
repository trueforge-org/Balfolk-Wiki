---
// @ts-nocheck

import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro';
import SidebarSublist from '@astrojs/starlight/components/SidebarSublist.astro';
import MobileMenuFooter from '@astrojs/starlight/components/MobileMenuFooter.astro';

const { sidebar } = Astro.locals.starlightRoute;

const currentPath = Astro.url.pathname;

// Filter helper for nested groups
function filterSidebar(items, pathPrefix: string) {
  return items
    .map(item => {
      if (item.type === 'link' && item.href.startsWith(pathPrefix)) {
        return item;
      } else if (item.type === 'group' && item.entries) {
        const filteredEntries = filterSidebar(item.entries, pathPrefix);
        if (filteredEntries.length > 0) {
          return { ...item, entries: filteredEntries };
        }
      }
      return null;
    })
    .filter(Boolean);
}

// Determine top-level segment. If on root (`/`), show the whole sidebar.
const segments = currentPath.split('/').filter(Boolean);
const topLevelPath = segments[0] ?? '';
let filteredSidebar;

if (!topLevelPath) {
  // Root path: don't filter â€” show entire sidebar
  filteredSidebar = sidebar;
} else {
  const topLevelPrefix = `/${topLevelPath}/`;
  filteredSidebar = filterSidebar(sidebar, topLevelPrefix);
}

// Unwrap the top-level group that matches the current path
let finalSidebar = filteredSidebar.map(item => {
  if (item.type === 'group' && item.label.toLowerCase() === topLevelPath.toLowerCase()) {
    return item.entries; // unwrap matched top-level group
  }
  return item;
}).flat();
---
<SidebarPersister>
  <SidebarSublist sublist={finalSidebar} />
</SidebarPersister>